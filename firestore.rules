rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // SAHOD SaaS - Firestore Security Rules
    // ============================================
    // Role Hierarchy:
    // 1. system_owner - Platform level (manages all companies)
    // 2. hr_client - Company level (manages their company only)
    // 3. employee - Self-service (own data only)
    // ============================================
    
    // System owner email - has full access
    function isSystemOwnerEmail() {
      return request.auth != null && request.auth.token.email == 'clarenceflores082001@gmail.com';
    }
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSystemOwner() {
      return isSystemOwnerEmail() || (isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().role == 'system_owner');
    }
    
    function isHrClient() {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().role == 'hr_client';
    }
    
    function isEmployee() {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().role == 'employee';
    }
    
    // Check if user belongs to a specific company
    function belongsToCompany(companyId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().companyId == companyId;
    }
    
    // Check if user is HR client of a specific company
    function isHrClientOfCompany(companyId) {
      return isHrClient() && belongsToCompany(companyId);
    }
    
    // Check if user is employee of a specific company
    function isEmployeeOfCompany(companyId) {
      return isEmployee() && belongsToCompany(companyId);
    }
    
    // Check if it's the user's own employee record
    function isOwnEmployeeRecord(employeeId) {
      return getUserData().employeeId == employeeId;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // System owner can read all users
      // HR client can read users in their company
      // Employee can read their own user doc
      allow read: if isSystemOwner() 
                  || request.auth.uid == userId
                  || (isHrClient() && exists(/databases/$(database)/documents/users/$(userId)) && get(/databases/$(database)/documents/users/$(userId)).data.companyId == getUserData().companyId);
      
      // System owner can create any user
      // HR client can create employees for their company
      // Users can create their own document on first login
      allow create: if isSystemOwner() 
                    || request.auth.uid == userId
                    || (isHrClient() && request.resource.data.companyId == getUserData().companyId && request.resource.data.role == 'employee');
      
      // Users can update their own profile (limited fields)
      // HR client can update employees in their company
      // System owner can update anyone
      allow update: if isSystemOwner()
                    || (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'companyId', 'permissions']))
                    || (isHrClient() && resource.data.companyId == getUserData().companyId && resource.data.role == 'employee');
      
      // Only system owner can delete users
      allow delete: if isSystemOwner();
    }

    // ============================================
    // PENDING REGISTRATIONS COLLECTION
    // Used by useRegistrationsStore for HR account signup flow
    // ============================================
    match /pendingRegistrations/{registrationId} {
      // Anyone can create (public registration)
      allow create: if true;
      
      // System owner can read and manage all pending registrations
      allow read, update, delete: if isSystemOwnerEmail();
    }

    // ============================================
    // HR USERS COLLECTION (Approved HR Accounts)
    // Used by useRegistrationsStore & useAuthStore for login validation
    // ============================================
    match /hrUsers/{userEmail} {
      // System owner can create and manage all HR users
      allow create, update, delete: if isSystemOwnerEmail();
      
      // Readable by authenticated users for login credential check.
      // NOTE: Move to a Cloud Function for stricter security in production.
      allow read: if true;
    }

    // ============================================
    // COMPANIES COLLECTION
    // ============================================
    match /companies/{companyId} {
      // System owner can read all companies
      // HR client and employees can read their own company
      allow read: if isSystemOwner() || belongsToCompany(companyId);
      
      // Only system owner can create companies (through registration approval)
      allow create: if isSystemOwner();
      
      // System owner can update any company
      // HR client can update their own company settings
      allow update: if isSystemOwner() 
                    || (isHrClientOfCompany(companyId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscription', 'status', 'hrClientId']));
      
      // Only system owner can delete companies
      allow delete: if isSystemOwner();
    }

    // ============================================
    // EMPLOYEES COLLECTION (within companies)
    // ============================================
    match /companies/{companyId}/employees/{employeeId} {
      // System owner can read (platform analytics only)
      // HR client can read employees in their company
      // Employee can read their own record
      allow read: if isSystemOwner() 
                  || isHrClientOfCompany(companyId) 
                  || (isEmployeeOfCompany(companyId) && isOwnEmployeeRecord(employeeId));
      
      // HR client can create employees in their company
      allow create: if isHrClientOfCompany(companyId);
      
      // HR client can update employees in their company
      // Employee can update limited fields in their own record
      allow update: if isHrClientOfCompany(companyId)
                    || (isEmployeeOfCompany(companyId) && isOwnEmployeeRecord(employeeId) 
                        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['salary', 'position', 'department', 'employmentType', 'status']));
      
      // HR client can delete employees in their company
      allow delete: if isHrClientOfCompany(companyId);
    }

    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    match /companies/{companyId}/attendance/{attendanceId} {
      // HR client can read all attendance in their company
      // Employee can read their own attendance
      allow read: if isHrClientOfCompany(companyId) 
                  || (isEmployeeOfCompany(companyId) && resource.data.employeeId == getUserData().employeeId);
      
      // HR client can create attendance records
      // Employee can clock in/out (create their own records)
      allow create: if isHrClientOfCompany(companyId)
                    || (isEmployeeOfCompany(companyId) && request.resource.data.employeeId == getUserData().employeeId);
      
      // HR client can update attendance (approve overtime, corrections)
      allow update: if isHrClientOfCompany(companyId);
      
      // HR client can delete attendance records
      allow delete: if isHrClientOfCompany(companyId);
    }

    // ============================================
    // LEAVES COLLECTION
    // ============================================
    match /companies/{companyId}/leaves/{leaveId} {
      // HR client can read all leaves in their company
      // Employee can read their own leaves
      allow read: if isHrClientOfCompany(companyId) 
                  || (isEmployeeOfCompany(companyId) && resource.data.employeeId == getUserData().employeeId);
      
      // HR client can create leave records
      // Employee can file leave request
      allow create: if isHrClientOfCompany(companyId)
                    || (isEmployeeOfCompany(companyId) && request.resource.data.employeeId == getUserData().employeeId);
      
      // HR client can approve/reject leaves
      // Employee can cancel their pending leaves
      allow update: if isHrClientOfCompany(companyId)
                    || (isEmployeeOfCompany(companyId) 
                        && resource.data.employeeId == getUserData().employeeId 
                        && resource.data.status == 'pending'
                        && request.resource.data.status == 'cancelled');
      
      // HR client can delete leaves
      // Employee can delete their pending leaves
      allow delete: if isHrClientOfCompany(companyId)
                    || (isEmployeeOfCompany(companyId) 
                        && resource.data.employeeId == getUserData().employeeId 
                        && resource.data.status == 'pending');
    }

    // ============================================
    // PAYROLL COLLECTION
    // ============================================
    match /companies/{companyId}/payroll/{payrollId} {
      // HR client can read all payroll in their company
      // Employee can read their own payslips
      allow read: if isHrClientOfCompany(companyId) 
                  || (isEmployeeOfCompany(companyId) && resource.data.employeeId == getUserData().employeeId);
      
      // Only HR client can create/update/delete payroll records
      allow create, update, delete: if isHrClientOfCompany(companyId);
    }

    // ============================================
    // DEPARTMENTS COLLECTION
    // ============================================
    match /companies/{companyId}/departments/{departmentId} {
      allow read: if isHrClientOfCompany(companyId) || isEmployeeOfCompany(companyId);
      allow create, update, delete: if isHrClientOfCompany(companyId);
    }

    // ============================================
    // POSITIONS COLLECTION
    // ============================================
    match /companies/{companyId}/positions/{positionId} {
      allow read: if isHrClientOfCompany(companyId) || isEmployeeOfCompany(companyId);
      allow create, update, delete: if isHrClientOfCompany(companyId);
    }

    // ============================================
    // SYSTEM CONFIGURATION (Platform Level)
    // Only System Owner can manage
    // ============================================
    match /system_config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSystemOwner();
    }
    
    // Tax tables (read-only for HR clients)
    match /tax_tables/{tableId} {
      allow read: if isAuthenticated();
      allow write: if isSystemOwner();
    }
    
    // Contribution rates (SSS, PhilHealth, Pag-IBIG)
    match /contribution_rates/{rateId} {
      allow read: if isAuthenticated();
      allow write: if isSystemOwner();
    }

    // ============================================
    // SUBSCRIPTION PLANS (Platform Level)
    // ============================================
    match /subscription_plans/{planId} {
      allow read: if isAuthenticated();
      allow write: if isSystemOwner();
    }

    // ============================================
    // COMPANY REGISTRATIONS (Pending Approvals)
    // Legacy alias â€” also kept as pendingRegistrations above
    // ============================================
    match /company_registrations/{registrationId} {
      // Anyone can create a registration (signup)
      allow create: if true;
      
      // Only system owner can read and manage registrations
      allow read, update, delete: if isSystemOwner();
    }

    // ============================================
    // PLATFORM ANALYTICS (System Owner Only)
    // ============================================
    match /platform_analytics/{docId} {
      allow read: if isSystemOwner();
      allow write: if isSystemOwner();
    }

    // ============================================
    // AUDIT LOGS
    // ============================================
    match /audit_logs/{logId} {
      // System owner can read all logs
      // HR client can read logs for their company
      allow read: if isSystemOwner() 
                  || (isHrClient() && resource.data.companyId == getUserData().companyId);
      
      // System creates audit logs automatically
      allow create: if isAuthenticated();
      allow update, delete: if false; // Audit logs are immutable
    }
  }
}
